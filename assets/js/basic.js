var persianName = {
    'ostan': 'استان',
    'vahed': 'واحد',
    'onvan': 'عنوان',
    'tmelk': 'نوع ملک',
    'sakhtar': 'ساختار',
    'karbari': 'نوع کاربری',
    'faliat': 'نوع فعالیت',
    'vaziat': 'وضعیت',
    "arse": "عرصه",
    "aeian": "اعیان",
    "salsakht": "سال ساخت",
    "salbana": "قدمت بنا",
    'adres': 'آدرس',
    "madarek": "مدارک موجود",
    "tarakom": "درصد تراکم ساختمانی",
    "sathesh": "سطح اشغال",
    "typeskelet": "نوع اسکلت",
    'malek': 'مالک',
    'plan': 'پلان',
    'plak': 'مشخصات پلاک ثبتی',
    'malekiat': 'وضعیت مالکیت',
    'tejare': 'تاریخ اجاره',
    'dejare': 'مبلغ دریافت اجاره',
    'ttamalok': 'تاریخ مالکیت',
    "pejare": "مبلغ اجاره",
    "ghimat_mlk": "قیمت تقریبی ملک",
    "moarez": "معارض",
    "tmoarez": "توضیحات معارض",
    "ty_bime": "نوع بیمه",
    "nam_bime": "شرکت بیمه",
    "sho_bime": "شماره بیمه",
    "dt_ex_bime": "تاریخ انقضا بیمه",
    "sh_paynkar": "شماره گواهی اتمام عملیات ساختمانی",
    "tpaynkar": "تاریخ پایان کار",
    "sarane": "سرانه نفر در متر مربع",
    "msetadi": "متراژ ستادی",
    "mamozeshi": "متراژ آموزشی",
    "melmikar": "متراژ آموزش  علمی کاربردی",
    "ma_ali": "متراژ آموزش عالی",
    "ma_kotah": "متراژ آموزش کوتاه مدت",
    "m_kar_a": "متراژ کارگاه آموزشی",
    "m_az_am": "متراژ آزمایشگاه آموزشی",
    "m_pazho": "متراژ پژوهشی",
    "m_darm_p": "متراژ درمانی",
    "m_groh_p": "متراژ گروه پژوهشی",
    "m_mkhtakh": "متراژ مرکز خدمات تخصصی",
    "m_kar_p": "متراژ کارگاه پژوهشی",
    "m_azma_p": "متراژ از آزمایشگاه پژوهشی",
    "m_farangi": "متراژ فرهنگی",
    "m_eshtegh": "متراژ اشتغال و تجاری سازی",
    "m_varzesh": "متراژ ورزشی",
    "m_eghamati": "متراژ اقامتی (رفاهی)",
    "m_refahi": "متراژ رفاهی و رستوران",
    "m_anbari": "متراژ انباری و موتور خانه",
    "m_moshaat": "متراژ راه پله و مشاعات",
    "m_park": "متراژ پارکینگ",
    "m_tasisat": "متراژ تاسیسات",
    "m_golkhane": "متراژ گلخانه",
    "t_tabagh": "تعداد طبقات ساختمان",
    "te_chah": "تعداد چاه",
    "te_cha_lai": "تعداد چاه لایه روبی",
    "tab_setad": "طبقات ستادی",
    "tab_amoz": "طبقات آموزشی",
    "tab_am_ali": "طبقات آموزش عالی",
    "tab_elmi": "طبقات آموزش علمی کاربردی",
    "tab_am_kot": "طبقات آموزش کوتاه مدت",
    "tab_kar_am": "طبقات کارگاه آموزشی",
    "tab_az_amo": "طبقات آزمایشگاه آموزشی",
    "tab_pazh": "طبقات پژوهشی",
    "tab_darm": "طبقات درمانی",
    "tab_gro_pa": "طبقات گروه پژوهشی",
    "tab_mkhd_t": "طبقات مرکز خدمات تخصصی",
    "tab_az_pa": "طبقات آزمایشگاه پژوهشی",
    "tab_kar_pa": "طبقات کارگاه پژوهشی",
    "tab_farang": "طبقات فرهنگی",
    "tab_eshteg": "طبقات اشتغال و تجاری سازی",
    "tab_var": "طبقات ورزشی",
    "tab_egh": "طبقات اقامتی",
    "tab_refah": "طبقات رفاهی و رستوران",
    "tab_anbar": "طبقات انباری",
    "tab_mosh": "راه پله و مشاعات",
    "tab_park": "طبقات پارکینگ",
    "tab_tasis": "طبقات تاسیسات",
    "ty_masale": "نوع مصالح",
    "mas_div_ot": "مصالح مصرفی دیوارهای خارجی",
    "mas_div_in": "مصالح مصرفی دیوارهای داخلی",
    "nama_ot": "نماهای خارجی",
    "posh_bam": "پوشش نهایی بام",
    "pangere": "پنجر ها",
    "kafrah": "کف راه پله",
    "ty_shishe": "نوع شیشه",
    "aigh_rdi_o": "عایق رطوبتی دیوارهای خارجی",
    "aigh_h_kaf": "عایق حرارتی کف",
    "aigh_h_sag": "عایق حرارتی سقف",
    "aigh_hdi_o": "عایق حرارتی دیوارههای خارجی",
    "sys_tabgh": "سیستم دسترسی به طبقات",
    "ty_khak": "نوع خاک",
    "ty_pay": "نوع پی",
    "ty_saghf": "نوع سقف",
    "di_saghf": "دیوار حائل زیر سقف",
    "ty_lol_ab": "نوع لوله مصرفی آب",
    "ty_lol_faz": "نوع لوله مصرفی فاضلاب",
    "ty_lol_gs": "نوع لوله مصرفی گرمایش و سرمایش",
    "ty_lol_gaz": "نوع لوله مصرفی گاز",
    "ty_sokht": "نوع سوخت مصرفی",
    "sys_grm": "سیستم گرمایشی",
    "sys_sarma": "سیستم سرمایش",
    "sys_entg_d": "سیستم انتقال گرما و سرما",
    "sys_daf_fa": "سیستم دفع فاضلاب",
    "sys_atash": "سیستم آتشنشانی",
    "ty_riz_ats": "نوع رایز سیستم آتشنشانی",
    "dak_servis": "داکت قابل سرویس",
    "sy_con_tas": "سیستم هوشمند کنترل تاسیسات",
    "makh_abats": "مغزن آب جهت سیستم آتشنشانی",
    "taj_atsh": "تجهیزات ارتفاع",
    "ser_dore": "سرویس دوره ای",
    "dt_ser_dor": "تاریخ سرویس دوره ای",
    "egzast": "سیستم اگزاست",
    "ty_asan": "نوع آسانسو",
    "te_asan": "تعداد آسانسور",
    "zarf_asan": "ظرفیت آسانسور",
    "tasis_jan": "تاسیسات جانبی",
    "lole_goz": "لوله گزاری",
    "ty_roshan": "مشخصات سیستم روشنایی",
    "madar_brgh": "مدار روشنایی و پریز",
    "sys_erth": "سیستم اتصال زمین",
    "sy_elam_ha": "سیستم اعلام حریق",
    "sys_darb": "سیستم بازشو درب ماشین",
    "sys_tel": "سیستم تلفن",
    "sys_ups": "سیستم برق اضطراری",
    "tavan_ups": "قدرت سیستم برق اضطراریی",
    "sh_esh_ab": "شماره اشتراک آب",
    "sh_esh_brg": "شماره اشتراک برق",
    "sh_esh_gaz": "شماره اشتراک گاز",
    "ty_con_ab": "نوع کنتور آب",
    "zar_con_ab": "ظرفیت کنتور آب",
    "ty_con_brg": "نوع کنتور برقه",
    "zr_con_brg": "ظرفیت کنتور برق",
    "ty_con_gaz": "نوع کنتور گاز",
    "zr_con_gaz": "ظرفیت کنتور گاز",
    "taj_sakht": "تجهیزات ساختمان",
    "te_chiler": "تعداد چیر",
    "te_brj_srd": "تعداد برج خنک کننده",
    "te_col_ab": "تعداد کولر آبی",
    "te_col_gaz": "تعداد کولر گازی",
    "te_boilr": "تعداد بویلر",
    "te_bokhari": "تعداد بخاری",
    "te_shomine": "تعداد شومینه گازی",
    "te_pakig": "تعداد پکیج",
    "te_skht_ab": "تعداد سختی گیر",
    "te_pomp_ab": "تعداد پمپ آبرسانی",
    "te_radiato": "تعداد رادیاتور",
    "te_fan_col": "تعداد فن کوئل",
    "te_makh_at": "تعداد مخازن ذخیره آب آتشنشانی",
    "te_makh_ab": "تعداد مخازن ذخیره آب",
    "te_zhnratr": "تعداد ژنراتور اضطراری",
    "te_dzlatsh": "تعداد دیزل پمپ آتشنشانی",
    "te_pak_col": "تعداد پکیج هوایی سرمایشی",
    "te_hava_sz": "تعداد هواساز",
    "te_manb_ab": " تعداد منابع آب گرم",
    "te_otg_srv": "تعداد اتاق سرور",
    "te_otg_tel": "تعداد اتاق مرکز تلفن",
    "marker": "کد پستی",
    "sardar": "لینک سردر",
    "mostanadat": "مستندات"
}
const icons = {
    'ساختمان': L.icon({
        iconUrl: buildingSVG,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    }),
    'گلخانه': L.icon({
        iconUrl: greenhouseSVG,
        iconSize: [17, 17],
        iconAnchor: [10, 10]
    }),
    'زمین': L.icon({
        iconUrl: landSVG,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    }),
    'آپارتمان': L.icon({
        iconUrl: apartmentSVG,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    }),
    'ساختمان با تجاری': L.icon({
        iconUrl: apartmentSVG,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    }),
    'اتاق': L.icon({
        iconUrl: apartmentSVG,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    }),

    'default': L.icon({
        iconUrl: defaultSVG,
        iconSize: [24, 24],
        iconAnchor: [10, 10]
    })
};

allIranData = allIranGeometry;
let layer;

// ---------------------------- main variable ----------------------------------
var myModal = new bootstrap.Modal(document.getElementById("staticBackdrop"), {});
var reportModal = new bootstrap.Modal(document.getElementById("reportModal"), {});
var printModal = new bootstrap.Modal(document.getElementById("printModal"), {});

async function downloadGeojsonToExcel(featureList, layerName) {
    if (!Array.isArray(featureList) || featureList.length === 0) {
        return;
    }

    const worksheetData = featureList.map(f => f.properties || {});
    const validKeys = Object.keys(persianName); // فقط کلیدهای موجود در persianName

    const filteredHeaders = validKeys.filter(key => key in worksheetData[0]);
    const headerLabels = filteredHeaders.map(key => persianName[key]);

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet("ویژگی‌ها");

    const logoUrl = '/static/images/logo.png';
    try {
        const logoBase64 = await urlToBase64(logoUrl);
        const imageId = workbook.addImage({
            base64: logoBase64,
            extension: 'png',
        });
        worksheet.addImage(imageId, {
            tl: {col: 8, row: 0},
            ext: {width: 100, height: 100},
        });
    } catch (error) {
    }

    const title = `اطلاعات مرتبط با املاک ${layerName}`;
    worksheet.addRow([title]);
    worksheet.mergeCells('A2:Z2');
    const titleCell = worksheet.getCell('A2');
    titleCell.alignment = {horizontal: 'center', vertical: 'middle'};
    titleCell.font = {name: 'B Nazanin', size: 20, bold: true};

    worksheet.addRow([]);
    worksheet.addRow([]);
    worksheet.addRow([]);

    const headerRow = worksheet.addRow(headerLabels);
    headerRow.font = {name: 'B Nazanin', bold: true, size: 13};
    headerRow.alignment = {horizontal: 'center', vertical: 'middle'};
    headerRow.eachCell(cell => {
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: {argb: 'FFCCE5FF'}
        };
        cell.border = {
            top: {style: 'thin'},
            left: {style: 'thin'},
            bottom: {style: 'thin'},
            right: {style: 'thin'}
        };
    });

    worksheetData.forEach(rowData => {
        const filteredRow = filteredHeaders.map(key => rowData[key] ?? '');
        const row = worksheet.addRow(filteredRow);
        row.font = {name: 'B Nazanin', size: 12};
        row.eachCell(cell => {
            cell.border = {
                top: {style: 'thin'},
                left: {style: 'thin'},
                bottom: {style: 'thin'},
                right: {style: 'thin'}
            };
        });
    });

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });
    saveAs(blob, 'features_export.xlsx'.replace('features_export', layerName));
}

async function urlToBase64(url) {
    const response = await fetch(url);
    const buffer = await response.arrayBuffer();
    const base64String = arrayBufferToBase64(buffer);
    return base64String;
}

function arrayBufferToBase64(buffer) {
    let binary = '';
    let bytes = new Uint8Array(buffer);
    let length = bytes.byteLength;
    for (let i = 0; i < length; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
}

async function downloadToExcel(index, name = '') {
    let properties;
    for (let i = 0; i < allGeometry.features.length; i++) {
        if (allGeometry.features[i].properties['dbId'] === index) {
            properties = allGeometry.features[i].properties;
            break;
        }
    }
    if (!properties) {
        return;
    }

    const workbook = new ExcelJS.Workbook();
    const sheet = workbook.addWorksheet("Properties");
    sheet.mergeCells('A1', 'B1');
    const titleCell = sheet.getCell('A1');
    titleCell.value = 'جهاد دانشگاهی';
    titleCell.font = {
        name: 'B Nazanin',
        size: 16,
        bold: true
    };
    titleCell.alignment = {
        vertical: 'middle',
        horizontal: 'center'
    };

    const imageUrl = properties['sardar'];
    const base64 = await getBase64FromUrl(imageUrl);
    const imageId = workbook.addImage({
        base64: base64,
        extension: 'png',
    });
    sheet.addImage(imageId, {
        tl: {col: 5, row: 1},
        ext: {width: 140, height: 120}
    });

    // تنظیم ستون‌ها
    sheet.columns = [
        {header: 'عنوان', key: 'label', width: 30},
        {header: 'مقدار', key: 'value', width: 50}
    ];

    // استایل ردیف هدر
    const headerRow = sheet.getRow(2);
    headerRow.font = {
        name: 'B Nazanin',
        bold: true,
        size: 14
    };
    headerRow.alignment = {
        horizontal: 'center',
        vertical: 'middle'
    };
    headerRow.eachCell(cell => {
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: {argb: 'FFCCE5FF'}
        };
        cell.border = {
            top: {style: 'thin'},
            left: {style: 'thin'},
            bottom: {style: 'thin'},
            right: {style: 'thin'}
        };
    });

    // افزودن اطلاعات توصیفی
    for (const key of Object.keys(persianName)) {
        if (properties.hasOwnProperty(key)) {
            const row = sheet.addRow({
                label: persianName[key],
                value: properties[key]
            });

            row.font = {
                name: 'B Nazanin',
                size: 12
            };

            row.eachCell(cell => {
                cell.border = {
                    top: {style: 'thin'},
                    left: {style: 'thin'},
                    bottom: {style: 'thin'},
                    right: {style: 'thin'}
                };
            });
        }
    }

    // ذخیره فایل
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });
    saveAs(blob, `'${name}'.xlsx`);
}

async function getBase64FromUrl(url) {
    const response = await fetch(url);
    const blob = await response.blob();
    return await convertBlobToBase64(blob);
}

function convertBlobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = reject;
        reader.onload = () => {
            resolve(reader.result);
        };
        reader.readAsDataURL(blob);
    });
}

function downloadToKML(index, name) {
    const geoJsonData = {
        type: "FeatureCollection",
        features: index
    };
    convertGeoJSONToKML(geoJsonData, "layerName.kml".replace('layerName', name));
}

function convertGeoJSONToKML(geoJSON, fileName = "data.kml") {
    const kmlHeader = `<?xml version="1.0" encoding="UTF-8"?>
        <kml xmlns="http://www.opengis.net/kml/2.2">
        <Document>`;
    const kmlFooter = `</Document></kml>`;

    let kmlBody = "";

    geoJSON.features.forEach(feature => {
        const name = feature.properties.onvan || "بدون عنوان";
        const geometry = feature.geometry;

        if (geometry.type === "Polygon") {
            const outerRing = geometry.coordinates[0]; // حلقه‌ی خارجی (ممکنه inner ring هم باشه)
            const coordinatesKML = outerRing.map(coord => `${coord[0]},${coord[1]},0`).join(" ");

            kmlBody += `
<Placemark>
    <name>${name}</name>
    <Polygon>
        <outerBoundaryIs>
            <LinearRing>
                <coordinates>${coordinatesKML}</coordinates>
            </LinearRing>
        </outerBoundaryIs>
    </Polygon>
</Placemark>`;
        }
    });

    const fullKML = `${kmlHeader}${kmlBody}${kmlFooter}`;
    const blob = new Blob([fullKML], {type: "application/vnd.google-earth.kml+xml"});

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.click();
}

// ---------------------------- resizer page -----------------------------------
const resizers = document.querySelectorAll('.resizer');
let currentResizer;
let startX, startWidth1, startWidth2;

for (let resizer of resizers) {
    resizer.addEventListener('mousedown', function (e) {
        currentResizer = resizer;
        startX = e.clientX;

        const previousSibling = currentResizer.previousElementSibling;
        const nextSibling = currentResizer.nextElementSibling;

        startWidth1 = previousSibling.offsetWidth + 600;
        startWidth2 = nextSibling.offsetWidth + 600;

        document.addEventListener('mousemove', resize);
        document.addEventListener('mouseup', stopResize);
    });
}

function resize(e) {
    if (currentResizer) {
        const dx = e.clientX - startX;
        const previousSibling = currentResizer.previousElementSibling;
        const nextSibling = currentResizer.nextElementSibling;
        previousSibling.style.flex = `${startWidth1 + dx}px`;
        nextSibling.style.flex = `${startWidth2 - dx}px`;
    }
}

function stopResize() {
    document.removeEventListener('mousemove', resize);
    document.removeEventListener('mouseup', stopResize);
    currentResizer = null;
}

// ----------------------------- map dependencies --------------------------
var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
});

var OpenStreetMap_HOT = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Tiles style by <a href="https://www.hotosm.org/" target="_blank">Humanitarian OpenStreetMap Team</a> hosted by <a href="https://openstreetmap.fr/" target="_blank">OpenStreetMap France</a>'
});

var googleSatHibrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
});

var baseMaps = {
    "CyclOSM": CyclOSM,
    'hot osm': OpenStreetMap_HOT,
    "OpenStreetMap": osm,
    "imagery": googleSatHibrid,
};
L.control.layers(baseMaps, null, {position: 'topleft'}).addTo(map);

// -------------------------- nav bar ------------------------------------
var customControl = L.Control.extend({
    options: {position: 'topright'}, onAdd: function (map) {
        var container = L.DomUtil.create('div', 'custom-control');
        container.innerHTML = '<nav class="navbar navbar-expand-lg navbar-dark bg-secondary text-white rounded" dir="rtl">\n' +
            '  <div class="container" style="font-family: B Yekan">\n' +
            '    <div class="dropdown" style="margin-right: 20px">\n' +
            '      <button class="btn bg-white rounded p-1 m-1 dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">\n' +
            '        <img height="30px" class="text-center" src="http://185.213.164.61/static/images/logo.png" alt="">\n' +
            '      </button>\n' +
            '      <ul class="dropdown-menu text-end" aria-labelledby="dropdownMenuButton">\n' +
            '        <li><a class="dropdown-item" href="/logout">خروج از حساب</a></li>\n' +
            '      </ul>\n' +
            '    </div>\n' +
            '    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">\n' +
            '      <span class="navbar-toggler-icon"></span>\n' +
            '    </button>\n' +
            '    <div class="collapse navbar-collapse bg-secondary" id="navbarSupportedContent">\n' +
            '      <ul class="navbar-nav dropstart">\n' +
            '        <li class="nav-item">\n' +
            '          <a class="nav-link text-white pointerCursor" data-bs-toggle="modal" data-bs-target="#addNewFeatureModal">افزودن ملک</a>\n' +
            '        </li>\n' +
            '        <li class="nav-item">\n' +
            '          <a class="nav-link text-white pointerCursor" data-bs-toggle="modal" data-bs-target="#mainDocumentModal">مستندات</a>\n' +
            '        </li>\n' +
            '        <li class="nav-item">\n' +
            '          <a class="nav-link text-white pointerCursor" onclick="openLayerCanvas()">لایه ها</a>\n' +
            '        </li>\n' +
            '        <li class="nav-item">\n' +
            '          <a class="nav-link text-white pointerCursor" href="/report-panel/all">گزارش جامع</a>\n' +
            '        </li>\n' +
            '      </ul>\n' +
            '      <div class="d-flex position-relative" role="search">\n' +
            '        <input id="search-input" style="width: 300px" class="form-control me-2 form-control-sm" type="search" placeholder=" جستجو اطلاعات..." aria-label="جستجو">\n' +
            '        <button id="search-btn" class="btn btn-primary btn-sm">جستجو</button>\n' +
            '        <ul id="search-results" class="list-group position-absolute mt-2" style="width: 300px; z-index: 1000;"></ul>\n' +
            '      </div>\n' +
            '      <div class="margin-right-5">\n' +
            '        <div><span id="date"></span></div>\n' +
            '        <div><span id="time"></span></div>\n' +
            '      </div>\n' +
            '    </div>\n' +
            '  </div>\n' +
            '</nav>';
        return container;
    }
});
map.addControl(new customControl());
let searchResults = [];

document.getElementById('search-btn').addEventListener('click', function () {
    const query = document.getElementById('search-input').value;
    const resultsContainer = document.getElementById('search-results');
    resultsContainer.innerHTML = '';

    if (query.trim() === '') {
        return;
    }

    fetch(`/search-property/?query=${query}`)
        .then(response => response.json())
        .then(data => {
            const results = data.results;
            searchResults = results; // ذخیره نتایج جدید در حافظه
            if (results.length === 0) {
                resultsContainer.innerHTML = '<li class="list-group-item">نتیجه‌ای یافت نشد</li>';
            } else {
                results.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item pointerCursor';
                    listItem.onclick = function () {
                        let feature;
                        for (var i = 0; i < allGeometry.features.length; i++) {
                            if (allGeometry.features[i].properties['dbId'] === item.id) {
                                feature = allGeometry.features[i];
                            }
                        }
                        const geojsonLayer = L.geoJSON(feature);
                        const bounds = geojsonLayer.getBounds();
                        map.flyToBounds(bounds, {
                            padding: [200, 200],
                            duration: 1.5
                        });
                    };
                    listItem.textContent = JSON.stringify(item.name);
                    resultsContainer.appendChild(listItem);
                });
                resultsContainer.style.display = 'block';
            }
        })
        .catch(error => {
            resultsContainer.innerHTML = '<li class="list-group-item text-danger">خطا در جستجو</li>';
        });
});

document.addEventListener('click', function (event) {
    const searchInput = document.getElementById('search-input');
    const resultsContainer = document.getElementById('search-results');
    if (!searchInput.contains(event.target) && !resultsContainer.contains(event.target)) {
        resultsContainer.style.display = 'none'; // پنهان کردن لیست نتایج
    }
});

document.getElementById('search-input').addEventListener('click', function () {
    const resultsContainer = document.getElementById('search-results');
    if (searchResults.length > 0) {
        resultsContainer.style.display = 'block';
    }
});

// -------------------------- popover ------------------------------------
var CustomButton = L.Control.extend({
    options: {
        position: 'topright',
    },
    onAdd: function (map) {
        var container = L.DomUtil.create('div', '');

        var button = document.createElement('div');
        button.className = 'bg-white rounded p-1';
        button.innerHTML = `<a id="openAllFileId"><svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path fill-rule="evenodd" d="M5 9a7 7 0 1 1 8 6.93V21a1 1 0 1 1-2 0v-5.07A7.001 7.001 0 0 1 5 9Zm5.94-1.06A1.5 1.5 0 0 1 12 7.5a1 1 0 1 0 0-2A3.5 3.5 0 0 0 8.5 9a1 1 0 0 0 2 0c0-.398.158-.78.44-1.06Z" clip-rule="evenodd"/>
        </svg>
        </a>`;
        button.style.cursor = 'pointer';

        container.appendChild(button);

        // ایجاد عنصر محتوا به صورت داینامیک با دکمه بستن
        function createPopoverContent(popoverInstance) {
            var wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn-close" aria-label="Close" id="popoverCloseBtn"></button>
                </div>
                <div class="text-right mt-2">
                    <label for="latInput">عرض جغرافیایی (درجه)</label>
                    <input type="number" id="latInput" class="form-control form-control-sm">
                    <label for="lngInput">طول جغرافیایی (درجه)</label>
                    <input type="number" id="lngInput" class="form-control form-control-sm">
                </div>
                <div class="text-right mt-2">
                    <label for="utmXInput">X (UTM)</label>
                    <input type="number" id="utmXInput" class="form-control form-control-sm" placeholder="مقدار X UTM">
                </div>
                <div class="text-right mt-2">
                    <label for="utmYInput">Y (UTM)</label>
                    <input type="number" id="utmYInput" class="form-control form-control-sm" placeholder="مقدار Y UTM">
                </div>
                <div class="text-right mt-2">
                    <label for="utmZoneInput">منطقه UTM</label>
                    <input type="number" id="utmZoneInput" class="form-control form-control-sm" placeholder="منطقه UTM">
                </div>
                <button onclick="addMarker()" class="btn btn-sm btn-primary mt-2">افزودن نقطه</button>`;

            // اضافه کردن عملکرد بستن
            setTimeout(() => {
                const closeBtn = wrapper.querySelector('#popoverCloseBtn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        popoverInstance.hide();
                    });
                }
            }, 0);

            return wrapper;
        }

        const popover = new bootstrap.Popover(button, {
            html: true,
            content: () => createPopoverContent(popover),
            sanitize: false,
            trigger: 'manual',
            placement: 'left'
        });

        button.addEventListener('click', function () {
            let offcanvasEl = document.getElementById('layersOffCanvas');
            let bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
            if (!bsOffcanvas) {
                bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
            }
            bsOffcanvas.hide();

            if (button.getAttribute('aria-describedby')) {
                popover.hide();
            } else {
                popover.show();
            }
        });

        L.DomEvent.disableClickPropagation(container);

        return container;
    }
});
let markers = [];

function addMarker() {
    const lat = parseFloat(document.getElementById('latInput').value);
    const lng = parseFloat(document.getElementById('lngInput').value);

    const utmX = parseFloat(document.getElementById('utmXInput').value);
    const utmY = parseFloat(document.getElementById('utmYInput').value);
    const utmZone = parseInt(document.getElementById('utmZoneInput').value);

    if (!isNaN(utmX) && !isNaN(utmY) && !isNaN(utmZone)) {
        const latLng = convertUTMtoLatLng(utmX, utmY, utmZone);
        addMarkerToMap(latLng.lat, latLng.lng);
    } else if (!isNaN(lat) && !isNaN(lng)) {
        addMarkerToMap(lat, lng);
    } else {
        alert('لطفاً مختصات معتبر وارد کنید.');
    }
}

function addMarkerToMap(lat, lng) {
    const customIcon = L.divIcon({
        className: '',
        html: `
            <svg xmlns="http://www.w3.org/2000/svg" fill="#FF0000" viewBox="0 0 24 24" width="20" height="20">
                <circle cx="12" cy="12" r="10" />
            </svg>`,
        iconSize: [20, 20],
        iconAnchor: [10, 10],
        popupAnchor: [0, -10]
    });

    const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map)
        .bindPopup(`Lat: ${lat}<br>Lng: ${lng}`)
        .openPopup();

    markers.push(marker);

    // حرکت دوربین روی نقطه جدید
    map.flyTo([lat, lng], 16, {
        animate: true,
        duration: 1.5
    });
}


function convertUTMtoLatLng(x, y, zoneNumber) {
    const utmProjection = `+proj=utm +zone=${zoneNumber} +ellps=WGS84 +datum=WGS84 +units=m +no_defs`;
    const wgs84Projection = '+proj=longlat +datum=WGS84 +no_defs';
    const [lng, lat] = proj4(utmProjection, wgs84Projection, [x, y]);
    return {lat, lng};
}

map.addControl(new CustomButton());

// -------------------------- popover ------------------------------------
function convertUtmToLatLng(x, y, zone) {
    const utmProj = `+proj=utm +zone=${zone} +ellps=WGS84 +datum=WGS84 +units=m +no_defs`;
    const wgs84 = '+proj=longlat +datum=WGS84 +no_defs';
    const [lng, lat] = proj4(utmProj, wgs84, [x, y]);
    return [lat, lng];
}

var CustomButtonGon = L.Control.extend({
    options: {
        position: 'topright',
    },
    onAdd: function (map) {
        var container = L.DomUtil.create('div', '');

        var button = document.createElement('div');
        button.className = 'bg-white rounded p-1';
        button.innerHTML = `<a id="openPolygonControl"><svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path fill-rule="evenodd" d="M5.005 10.19a1 1 0 0 1 1 1v.233l5.998 3.464L18 11.423v-.232a1 1 0 1 1 2 0V12a1 1 0 0 1-.5.866l-6.997 4.042a1 1 0 0 1-1 0l-6.998-4.042a1 1 0 0 1-.5-.866v-.81a1 1 0 0 1 1-1ZM5 15.15a1 1 0 0 1 1 1v.232l5.997 3.464 5.998-3.464v-.232a1 1 0 1 1 2 0v.81a1 1 0 0 1-.5.865l-6.998 4.042a1 1 0 0 1-1 0L4.5 17.824a1 1 0 0 1-.5-.866v-.81a1 1 0 0 1 1-1Z" clip-rule="evenodd"/>
          <path d="M12.503 2.134a1 1 0 0 0-1 0L4.501 6.17A1 1 0 0 0 4.5 7.902l7.002 4.047a1 1 0 0 0 1 0l6.998-4.04a1 1 0 0 0 0-1.732l-6.997-4.042Z"/>
        </svg></a>`;
        button.style.cursor = 'pointer';
        container.appendChild(button);

        // فقط یک بار ساخته میشه
        const popoverContentDiv = document.createElement('div');
        popoverContentDiv.innerHTML = `
            <div class="d-flex justify-content-end">
                <button type="button" class="btn-close" aria-label="Close" id="polygonPopoverClose"></button>
            </div>
            <div id="pointsContainer" class="mt-2"></div>
            <button id="addRowBtn" class="btn btn-sm btn-secondary mt-2">افزودن ردیف جدید</button>
            <button id="drawPointsBtn" class="btn btn-sm btn-primary mt-2">رسم همه نقاط</button>
            <button id="clearPolygonBtn" class="btn btn-sm btn-danger mt-2">پاک‌سازی</button>
            <button id="saveGeoJsonBtn" class="btn btn-sm btn-success mt-2">ذخیره</button>
        `;

        const popover = new bootstrap.Popover(button, {
            html: true,
            content: popoverContentDiv,
            sanitize: false,
            trigger: 'manual',
            placement: 'left'
        });

        // تابع برای ساخت ردیف جدید
        function addInputRow() {
            const row = document.createElement('div');
            row.classList.add('row', 'mb-2', 'align-items-center');
            row.innerHTML = `
                <div class="col-5">
                    <input type="number" class="form-control form-control-sm lat-input" placeholder="عرض">
                </div>
                <div class="col-5">
                    <input type="number" class="form-control form-control-sm lng-input" placeholder="طول">
                </div>
                <div class="col-2 text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" title="حذف ردیف">×</button>
                </div>
            `;
            row.querySelector('.remove-row-btn').addEventListener('click', function () {
                const allRows = document.querySelectorAll('#pointsContainer .row');
                if (allRows.length > 3) {
                    row.remove();
                } else {
                    alert('حداقل باید سه نقطه وارد شود.');
                }
            });
            document.getElementById('pointsContainer').appendChild(row);
        }

        let initialized = false;

        button.addEventListener('click', function () {
            const offcanvasEl = document.getElementById('layersOffCanvas');
            let bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
            if (!bsOffcanvas) {
                bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
            }
            bsOffcanvas.hide();

            if (button.getAttribute('aria-describedby')) {
                popover.hide();
            } else {
                popover.show();

                if (!initialized) {
                    initialized = true;

                    // حداقل ۳ ردیف
                    for (let i = 0; i < 3; i++) addInputRow();

                    document.getElementById('addRowBtn').addEventListener('click', addInputRow);

                    document.getElementById('drawPointsBtn').addEventListener('click', function () {
                        const latInputs = document.querySelectorAll('.lat-input');
                        const lngInputs = document.querySelectorAll('.lng-input');
                        for (let i = 0; i < latInputs.length; i++) {
                            const val1 = parseFloat(latInputs[i].value);
                            const val2 = parseFloat(lngInputs[i].value);

                            if (isNaN(val1) || isNaN(val2)) continue;

                            let latLng = null;

                            if (val1 > 100000 && val2 > 1000000) {
                                latLng = convertUtmToLatLng(val1, val2, 39);
                            } else if (val1 > 1000000 && val2 > 100000) {
                                latLng = convertUtmToLatLng(val2, val1, 39);
                            } else {
                                latLng = [val1, val2];
                            }

                            addPolygonPoint(latLng, map);
                        }
                    });

                    document.getElementById('saveGeoJsonBtn').addEventListener('click', function () {
                        if (polygonPoints.length >= 3) {
                            const tempPolygon = L.polygon(polygonPoints);
                            const geojson = tempPolygon.toGeoJSON();
                            geojson.properties = persianName;
                            addGroupLayerWithFeatures([geojson], true, 'لایه جدید');
                            clearPolygon(map);
                        } else {
                            alert("برای ساخت GeoJSON حداقل ۳ نقطه نیاز است.");
                        }
                    });

                    document.getElementById('clearPolygonBtn').addEventListener('click', function () {
                        clearPolygon(map);
                    });

                    document.getElementById('polygonPopoverClose').addEventListener('click', function () {
                        popover.hide();
                    });
                }
            }
        });

        L.DomEvent.disableClickPropagation(container);
        return container;
    }
});
let polygonPoints = [];
let markerList = [];
let polygonShape = null;

function addPolygonPoint(point, map) {
    const [lat, lng] = point;
    polygonPoints.push(point);

    const customIcon = L.divIcon({
        className: '',
        html: `<svg xmlns="http://www.w3.org/2000/svg" fill="#007bff" viewBox="0 0 24 24" width="20" height="20">
                <circle cx="12" cy="12" r="10" />
            </svg>`,
        iconSize: [20, 20],
        iconAnchor: [10, 20]
    });

    const marker = L.marker(point, {icon: customIcon, draggable: false}).addTo(map)
        .bindPopup(`Lat: ${lat}<br>Lng: ${lng}`)
        .openPopup();

    marker.on('click', function () {
        map.removeLayer(marker);
        const index = markerList.indexOf(marker);
        if (index > -1) {
            markerList.splice(index, 1);
            polygonPoints.splice(index, 1);
        }
        drawPolygon(map);
    });

    markerList.push(marker);
    drawPolygon(map);
}

function drawPolygon(map) {
    if (polygonShape) {
        map.removeLayer(polygonShape);
        polygonShape = null;
    }

    if (polygonPoints.length >= 3) {
        polygonShape = L.polygon(polygonPoints, {color: 'blue'}).addTo(map);
        map.fitBounds(polygonShape.getBounds());
    }
}

function clearPolygon(map) {
    markerList.forEach(marker => map.removeLayer(marker));
    markerList = [];
    polygonPoints = [];
    if (polygonShape) {
        map.removeLayer(polygonShape);
        polygonShape = null;
    }
}

map.addControl(new CustomButtonGon());

// -------------------------- mouse location ------------------------------------
var mouseControl = L.Control.extend({
    options: {position: 'bottomleft'}, onAdd: function (map) {
        var container = L.DomUtil.create('div', 'custom-control');
        container.innerHTML = '<div class="bg-secondary text-white rounded p-1">' +
            '<a id="mousePosition">موقعیت نشانگر</a>' +
            '</div>';
        return container;
    }
});
map.addControl(new mouseControl());
map.on('mousemove', function (e) {
    var position = `${e.latlng.lat.toFixed(3)}, ${e.latlng.lng.toFixed(3)}`
    document.getElementById('mousePosition').innerText = position
});

// -------------------------- legend -------------------------------------------
L.Control.IconLegend = L.Control.extend({
    onAdd: function (map) {
        var div = L.DomUtil.create('div', 'icon-legend');
        div.innerHTML = '<div class="bg-info-subtle rounded"><img width="30px" src="' + detailSVG + '" class="pointerCursor" onclick="toggleLegend()"></div>';
        return div;
    }
});
L.control.iconLegend = function (opts) {
    return new L.Control.IconLegend(opts);
}
L.control.iconLegend({position: 'bottomleft'}).addTo(map);

function toggleLegend(event) {
    var legendContent = document.getElementById('legend-content');
    if (!legendContent) {
        legendContent = document.createElement('div');
        legendContent.className = 'rounded bg-info'
        legendContent.id = 'legend-content';
        legendContent.style.position = 'absolute';
        legendContent.style.bottom = '90px';
        legendContent.style.fontFamily = 'BYekan+'
        legendContent.style.left = '10px';
        legendContent.style.padding = '10px';
        const uniqueIcons = new Set();
        for (const key in icons) {
            if (icons.hasOwnProperty(key) && !uniqueIcons.has(icons[key].options.iconUrl)) {
                if (key !== 'default') {
                    legendContent.innerHTML += `<div class="mb-1 d-flex"><img src="${icons[key].options.iconUrl}" width="30px" alt=""><small class="p-1">${key}</small></div>`;
                    uniqueIcons.add(icons[key].options.iconUrl);
                } else {
                    legendContent.innerHTML += `<div class="mb-1 d-flex"><img src="${icons[key].options.iconUrl}" width="30px" alt=""><small class="p-1">نامشخص</small></div>`;
                    uniqueIcons.add(icons[key].options.iconUrl);
                }
            }
        }
        document.querySelector('.leaflet-bottom.leaflet-left').appendChild(legendContent);
    } else {
        legendContent.style.display = (legendContent.style.display === 'none') ? 'block' : 'none';
    }
}

const markerGroup = L.layerGroup().addTo(map);

// -------------------------- legend -------------------------------------------
L.Control.ClearLayers = L.Control.extend({
    onAdd: function (map) {
        var div = L.DomUtil.create('div', 'icon-legend');
        div.innerHTML = `
            <div class="bg-danger rounded p-1">
                <img 
                    width="20px" 
                    src="${deleteSVG}" 
                    alt="Clear Layers" 
                    title="پاک کردن لایه‌ها" 
                    class="pointerCursor text-danger" 
                    onclick="clearLayer()"
                >
            </div>
        `;
        return div;
    }
});
L.control.clearLayers = function (opts) {
    return new L.Control.ClearLayers(opts);
}
L.control.clearLayers({position: 'bottomleft'}).addTo(map);

function clearLayer() {
    markerGroup.clearLayers();
}

// -------------------------- legend -------------------------------------------
L.Control.ApproveEdit = L.Control.extend({
    onAdd: function (map) {
        var div = L.DomUtil.create('div', 'icon-legend');
        div.innerHTML = `
            <div class="bg-body-secondary rounded p-1">
                <img 
                    width="20px" 
                    src="${approveSVG}"  
                    alt="Clear Layers" 
                    title="تایید اطلاعات" 
                    class="pointerCursor text-danger" 
                    onclick="approveEditModal()">
            </div>`;
        return div;
    }
});
L.control.approveEdit = function (opts) {
    return new L.Control.ApproveEdit(opts);
}
L.control.approveEdit({position: 'bottomleft'}).addTo(map);

function approveEditModal() {
    var myModal = new bootstrap.Modal(document.getElementById('approveChangeModal'));
    myModal.show();

}

// -------------------------- chat bot -------------------------------------------
// L.Control.ChatBot = L.Control.extend({
//     onAdd: function (map) {
//         var div = L.DomUtil.create('div', 'chat-bot');
//         div.innerHTML = `
//             <div class="bg-info-subtle rounded position-relative ">
//                 <img width="45px" src="` + chatBotSVG + `"
//                      class="pointerCursor"
//                      onclick="toggleChatBox()" alt="">
//                 <div id="chatBox" class="chat-box bg-light rounded p-1 shadow" style="
//                 position: absolute; bottom: 60px; right: 0; min-height: 400px; width: 400px; display: flex; flex-direction: column; justify-content: space-between;">
//                     <div>
//                         <div class="d-flex justify-content-between">
//                             <span class="pointerCursor text-danger" onclick="closeChatBox()">بستن</span>
//                             <h4>چت بات هوش مصنوعی</h4>
//                         </div>
//                         <div class="chat-content d-flex justify-content-end mt-1" style="flex-grow: 1; overflow: hidden">
//                             <div style="margin-right: 2px" class="bg-success rounded-bottom rounded-start p-1 mt-1">
//                                 <span class="text-white" style="margin-right: 5px">سلام جطوری میتونم بهت کمک کن</span>
//                             </div>
//                             <span class="material-symbols-outlined" style="font-size: 30px">support_agent</span>
//                         </div>
//                         <div class="mt-2" id="allNewMessages"></div>
//                     </div>
//                     <div class="input-group input-group-sm" style="position: relative;">
//                         <button class="btn btn-outline-secondary" id="button-addon1"
//                             class="submit_btn">ارسال</button>
//                         <input dir="rtl" type="text" class="form-control" placeholder="سوال خود را بنویسید ..."
//                             aria-label="Example text with button addon" aria-describedby="button-addon1"
//                              id="query" name="query">
//                     </div>
//                 </div>
//             </div>
//         `;
//         return div;
//     }
// });
//
// L.control.chatBot = function (opts) {
//     return new L.Control.ChatBot(opts);
// };
//
// L.control.chatBot({position: 'bottomright'}).addTo(map);
//
// function toggleChatBox() {
//     var chatBox = document.getElementById("chatBox");
//     if (chatBox.style.display === "none") {
//         chatBox.style.display = "flex";
//     } else {
//         chatBox.style.display = "none";
//     }
// }
//
// function closeChatBox() {
//     var chatBox = document.getElementById("chatBox");
//     chatBox.style.display = "none";
// }
//
// const submit_btn = document.getElementById("button-addon1");
// const txtUserInp = document.querySelector("#query");
//
// submit_btn.onclick = function (e) {
//     e.preventDefault();
//     if (txtUserInp.value === "") {
//         return
//     }
//     submit_btn.disabled = true;
//
//     let messageText = document.getElementById('query').value
//     let requestData = {query: messageText};
//     addMessageToChatBox(messageText, "user")
//     txtUserInp.value = '';
//     $.ajax({
//         method: "GET",
//         url: "/chat/request",
//         // headers: {
//         //     "Content-type": "application/json",
//         //     "X-Requested-With": "XMLHttpRequest",
//         //"X-CSRFToken": csrftoken,
//         // },
//         data: requestData
//     })
//         .done(function (response) {
//             submit_btn.disabled = false;
//             const botRes = JSON.stringify(response);
//             const obj = JSON.parse(botRes);
//             addMessageToChatBox(obj.Bot, "bot")
//             if (obj.function === 'openLegend') {
//                 toggleLegend()
//             } else if (obj.function === 'showProvince') {
//                 var province = obj.otherDetail['province']
//                 showProvinceLayer(province);
//             }
//         })
//         .fail(function (response) {
//             console.log(response)
//         })
// }
//
// function addMessageToChatBox(message, type) {
//     var allNewMessages = document.getElementById('allNewMessages')
//     if (type === 'user') {
//         var newUserMessage = `<div class="chat-content d-flex justify-content-start mt-1" style="flex-grow: 1; overflow: hidden;">
//                                         <span class="material-symbols-outlined" style="font-size: 30px">support_agent</span>
//                                         <div style="margin-right: 2px" class="bg-primary rounded-bottom rounded-end p-1 mt-1">
//                                             <span class="text-white" style="margin-right: 5px">${message}</span>
//                                         </div>
//                                     </div>`;
//         allNewMessages.innerHTML += newUserMessage
//     } else {
//         var newBotMessage = `<div class="chat-content d-flex justify-content-end mt-1" style="flex-grow: 1; overflow: hidden;">
//                                         <div style="margin-right: 2px" class="bg-success rounded-bottom rounded-start p-1 mt-1 text-right">
//                                             <span class="text-white" style="margin-right: 5px">${message}</span>
//                                         </div>
//                                         <span class="material-symbols-outlined" style="font-size: 30px">support_agent</span>
//                                     </div>`;
//         allNewMessages.innerHTML += newBotMessage
//     }
// }

//  ---------------- show time ----------------------------
function updateTime() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    const timeString = `${hours}:${minutes}:${seconds}`;

    const date = now.toLocaleDateString('fa-IR').split('/');
    document.getElementById('time').textContent = timeString;
    document.getElementById('date').textContent = date[2] + ' - ' + date[1] + ' - ' + date[0];
}

setInterval(updateTime, 1000);

// ------------------------ from url ----------------------
function updateProgressBar(percentage) {
    const progressBar = document.querySelector('.progress-bar');
    progressBar.style.width = percentage + '%';
    progressBar.setAttribute('aria-valuenow', percentage);
}

const layerOffCanvas = document.getElementById("layersOffCanvas");

function zoomToFeature(index) {
    let feature;
    for (var i = 0; i < allGeometry.features.length; i++) {
        if (allGeometry.features[i].properties['dbId'] === parseInt(index)) {
            feature = allGeometry.features[i]
        }
    }
    const geojsonLayer = L.geoJSON(feature)
    const bounds = geojsonLayer.getBounds();
    map.flyToBounds(bounds, {
        padding: [200, 200],
        duration: 1.5
    });
}

const loadMoreBtn = document.getElementById('loadMoreBtn');
let loadedCount = 0;
const batchSize = 20;
let currentFeatures = [];
let activeFilters = {};
const tableHead = document.getElementById('geojson-table-head');
const tableBody = document.getElementById('geojson-table-body');
let filteredGeojson;
let currentSort = {key: null, ascending: true};

function sortTable(key) {
    showLoadingAlert('در حال مرتب‌سازی جدول');
    setTimeout(() => {
        if (currentSort.key === key) {
            currentSort.ascending = !currentSort.ascending;
        } else {
            currentSort.key = key;
            currentSort.ascending = true;
        }
        currentFeatures.sort((a, b) => {
            const valueA = a.properties[key];
            const valueB = b.properties[key];

            const isNumberA = !isNaN(parseFloat(valueA)) && isFinite(valueA);
            const isNumberB = !isNaN(parseFloat(valueB)) && isFinite(valueB);

            if (isNumberA && isNumberB) {
                return currentSort.ascending
                    ? parseFloat(valueA) - parseFloat(valueB)
                    : parseFloat(valueB) - parseFloat(valueA);
            } else {
                return currentSort.ascending
                    ? String(valueA).localeCompare(String(valueB), 'fa')
                    : String(valueB).localeCompare(String(valueA), 'fa');
            }
        });
        tableBody.innerHTML = '';
        loadedCount = 0;
        generateRows(currentFeatures);
        updateHeaderSortIcons();
        saveSortConfig();
        Swal.close();
    }, 500);
}

function updateHeaderSortIcons() {
    const headers = tableHead.querySelectorAll('th[data-key]');
    headers.forEach(th => {
        const key = th.getAttribute('data-key');
        const titleSpan = th.querySelector('.column-title');
        if (!titleSpan) return;

        const originalTitle = persianName[key] || titleSpan.textContent.split(' ')[0];

        // متن جدید
        let newTitle = originalTitle;
        if (key === currentSort.key) {
            newTitle += ` ${currentSort.ascending ? '⬆️' : '⬇️'}`;
        }

        titleSpan.textContent = newTitle;

    });
}

function saveSortConfig() {
    localStorage.setItem('currentSort', JSON.stringify(currentSort));
}

function generateHeaders(features) {
    const keys = Object.keys(features[0].properties);
    const headerRow = document.createElement('tr');
    headerRow.innerHTML += `<th  style="background-color: #4d5154">#</th>`;
    headerRow.innerHTML += `<th style="background-color: #4d5154">بزرگنمایی</th>`;

    const validKeys = Object.keys(persianName).filter(key => keys.includes(key));
    generateHeaders.validKeys = validKeys;

    validKeys.forEach(key => {
        const name = persianName[key];
        headerRow.innerHTML += `
            <th style="cursor: pointer; white-space: nowrap; background-color: #4d5154" data-key="${key}">
                ${name}
            </th>`;
    });

    tableHead.innerHTML = '';
    tableHead.appendChild(headerRow);
    const existingToolsRow = document.querySelector('#tools-row');
    if (existingToolsRow) existingToolsRow.remove();

    tableHead.querySelectorAll('th[data-key]').forEach(th => {
        th.addEventListener('click', () => {
            const key = th.getAttribute('data-key');

            const oldRow = document.querySelector('#tools-row');
            if (oldRow) oldRow.remove();

            const itemList = [];
            for (const f of features) {
                const val = f.properties[key];
                if (!itemList.includes(val)) itemList.push(val);
            }
            const dropdownItems = itemList.map(item => `
                <li><label class="dropdown-item text-black">
                    <input type="checkbox" class="filter-checkbox" data-value="${item}"> ${item}
                </label></li>`).join('');

            const toolsRow = document.createElement('tr');
            toolsRow.id = 'tools-row';
            toolsRow.innerHTML = `
                <td colspan="${validKeys.length + 2}">
                    <div class="d-flex gap-2 align-items-center flex-wrap mt-2">
                        <button class="btn btn-primary btn-sm apply-filter" data-key="${key}">اعمال</button>
                        <button class="btn btn-danger btn-sm clear-filter" data-key="${key}">حذف</button>
                        <button class="btn btn-outline-secondary btn-sm sort-asc" data-key="${key}" title="مرتب‌سازی صعودی">⬆️</button>
                        <button class="btn btn-outline-secondary btn-sm sort-desc" data-key="${key}" title="مرتب‌سازی نزولی">⬇️</button>
                        <div class="dropdown">
                            <button class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">لیست</button>
                            <ul class="dropdown-menu dropdown-menu-end bg-white text-end" style="height: 200px; overflow-y: scroll;" data-key="${key}">
                                ${dropdownItems}
                            </ul>
                        </div>
                        <button class="btn btn-outline-dark btn-sm ms-auto" id="hideToolsBtn" title="بستن ابزار">❌</button>
                    </div>
                </td>`;

            headerRow.after(toolsRow);
            setupFilterButtons();
            const hideBtn = document.getElementById('hideToolsBtn');
            if (hideBtn) {
                hideBtn.addEventListener('click', () => {
                    const row = document.getElementById('tools-row');
                    if (row) row.remove();
                });
            }

        });
    });
}

function setupFilterButtons() {
    const toolsRow = document.getElementById('tools-row');
    if (!toolsRow) return;

    const applyButtons = toolsRow.querySelectorAll('.apply-filter');
    applyButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            showLoadingAlert('در حال اعمال تغییرات');
            setTimeout(() => {
                const key = btn.getAttribute('data-key');
                const checkboxes = toolsRow.querySelectorAll(`.dropdown-menu[data-key="${key}"] .filter-checkbox:checked`);
                const selectedValues = Array.from(checkboxes).map(cb => cb.dataset.value);

                if (selectedValues.length > 0) {
                    activeFilters[key] = selectedValues;
                } else {
                    delete activeFilters[key];
                }

                applyFilters();
            }, 500);
        });
    });

    const clearButtons = toolsRow.querySelectorAll('.clear-filter');
    clearButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            showLoadingAlert('در حال حذف فیلتر');
            setTimeout(() => {
                const key = btn.getAttribute('data-key');
                delete activeFilters[key];
                const dropdownMenu = toolsRow.querySelector(`.dropdown-menu[data-key="${key}"]`);
                if (dropdownMenu) {
                    dropdownMenu.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
                }
                applyFilters();
            }, 500);
        });
    });

    // اضافه کردن event به دکمه‌های مرتب‌سازی داخل ابزار
    const sortAscButtons = toolsRow.querySelectorAll('.sort-asc');
    sortAscButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const key = btn.getAttribute('data-key');
            currentSort.key = key;
            currentSort.ascending = true;
            sortTable(key);
        });
    });

    const sortDescButtons = toolsRow.querySelectorAll('.sort-desc');
    sortDescButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const key = btn.getAttribute('data-key');
            currentSort.key = key;
            currentSort.ascending = false;
            sortTable(key);
        });
    });
}

document.addEventListener('click', (event) => {
    if (event.target.id === 'toggleFiltersBtn') {
        const toolsRow = document.getElementById('tools-row');
        if (toolsRow) {
            toolsRow.style.display = toolsRow.style.display === 'none' ? '' : 'none';
        }
    }
});

function applyFilters() {
    tableBody.innerHTML = '';
    loadedCount = 0;


    let filteredFeatures = currentFeatures;
    Object.entries(activeFilters).forEach(([key, values]) => {
        filteredFeatures = filteredFeatures.filter(feature => {
            const featureValue = feature.properties[key];
            if (Array.isArray(values) && values.length > 0) {
                return values.some(selectedValue =>
                    featureValue !== undefined && featureValue !== null && featureValue.toString().includes(selectedValue)
                );
            } else if (values) {
                return featureValue !== undefined && featureValue !== null && featureValue.toString().includes(values);
            }
            return true;
        });
    });

    if (filteredFeatures.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="100%" style="text-align:center;">موردی پیدا نشد</td></tr>`;
        loadMoreBtn.style.display = 'none';
    } else {
        generateRows(filteredFeatures);
        loadMoreBtn.style.display = filteredFeatures.length > batchSize ? 'block' : 'none';
        loadMoreBtn.onclick = () => generateRows(filteredFeatures);
    }

    filteredGeojson = {
        type: "FeatureCollection",
        features: filteredFeatures.map(feature => ({
            type: "Feature",
            geometry: feature.geometry,
            properties: feature.properties
        }))
    };

    updateActiveFiltersUI();
    Swal.close();
}

function updateActiveFiltersUI() {
    const activeFiltersContainer = document.getElementById('activeFiltersContainer');
    activeFiltersContainer.innerHTML = '';
    Object.entries(activeFilters).forEach(([key, value]) => {
        const filterElement = document.createElement('span');
        filterElement.classList.add('active-filter');
        filterElement.style = "background-color: #f0f0f0; padding: 3px; border-radius: 20px; display: flex; align-items: center; gap: 5px;";
        filterElement.innerHTML = `
            <span><strong>${persianName[key] || key}:</strong> ${value}</span>
            <button onclick="removeFilter('${key}')" style="background: none; border: none; color: red; cursor: pointer;">❌</button>
        `;
        activeFiltersContainer.appendChild(filterElement);
    });
}

function removeFilter(key) {
    showLoadingAlert("در حال حذف فیلتر")
    setTimeout(function () {
        delete activeFilters[key];
        applyFilters();
    }, 500);

}

function generateRows(features) {
    const rowsToLoad = features.slice(loadedCount, loadedCount + batchSize);
    const validKeys = generateHeaders.validKeys;
    rowsToLoad.forEach((feature, index) => {
        const row = document.createElement('tr');
        row.innerHTML += `<td class="">${loadedCount + index + 1}</td>`;
        row.innerHTML += `
            <td>
                <span class="material-symbols-outlined pointer text-primary" id="tableZoom${index}"
                       onclick="zoomToFeature(${feature.properties['dbId']})">
                    recenter
                </span>
            </td>`;
        validKeys.forEach(key => {
            const value = feature.properties[key] !== undefined ? feature.properties[key] : '';
            row.innerHTML += `<td data-column-id="${key}" style="font-size: 13px">${value}</td>`;
        });
        tableBody.appendChild(row);
    });
    loadedCount += rowsToLoad.length;
    loadMoreBtn.style.display = loadedCount >= features.length ? 'none' : 'block';
}

function initializeTable(geojson) {
    setTimeout(() => {
        if (geojson && geojson.length > 0) {
            currentFeatures = geojson;
            activeFilters = {};
            generateHeaders(geojson);
            generateRows(geojson);
            loadMoreBtn.style.display = 'block';
            loadMoreBtn.onclick = () => generateRows(geojson);
        } else {
            loadMoreBtn.style.display = 'none';
        }
        Swal.close();
        var offcanvas_ = new bootstrap.Offcanvas(document.getElementById('attributeTableOffCanvas'));
        offcanvas_.show();
    }, 500);
}

function initializeDropdown(features) {
    const keys = Object.keys(features[0].properties);
    const columnsMenu = document.getElementById('columnsMenu');
    const dropdownSearch = document.getElementById('dropdownSearch');
    columnsMenu.innerHTML = '';
    const selectAllItem = document.createElement('li');
    selectAllItem.innerHTML = `
        <label class="dropdown-item text-end">
            <input type="checkbox" id="selectAllCheckbox"> انتخاب همه
        </label>`;
    columnsMenu.appendChild(selectAllItem);
    keys.forEach(key => {
        if (persianName[key] !== undefined) {
            const menuItem = document.createElement('li');
            menuItem.innerHTML = `
                <label class="dropdown-item text-end">
                    <input type="checkbox" class="column-checkbox" value="${key}" checked> ${persianName[key]}
                </label>`;
            columnsMenu.appendChild(menuItem);
        }
    });

    dropdownSearch.addEventListener('input', () => {
        const searchTerm = dropdownSearch.value.toLowerCase();
        const items = columnsMenu.getElementsByTagName('li');
        Array.from(items).forEach(item => {
            const label = item.querySelector('label');
            const text = label.textContent.toLowerCase();
            item.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });
    document.getElementById('selectAllCheckbox').addEventListener('change', function () {
        const checked = this.checked;
        document.querySelectorAll('.column-checkbox').forEach(cb => {
            cb.checked = checked;
        });
        toggleColumns();
    });

    document.querySelectorAll('.column-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const allChecked = Array.from(document.querySelectorAll('.column-checkbox')).every(cb => cb.checked);
            document.getElementById('selectAllCheckbox').checked = allChecked;
            toggleColumns();
        });
    });

    const allChecked = Array.from(document.querySelectorAll('.column-checkbox')).every(cb => cb.checked);
    document.getElementById('selectAllCheckbox').checked = allChecked;
}

function clearTableState() {
    // حذف تنظیمات فیلتر و مرتب‌سازی
    activeFilters = {};
    currentSort = {key: null, ascending: true};
    localStorage.removeItem('currentSort');

    // پاک‌کردن نمایش فیلترهای فعال
    const activeFiltersContainer = document.getElementById('activeFiltersContainer');
    if (activeFiltersContainer) activeFiltersContainer.innerHTML = '';

    // حذف ابزار فیلتر
    const toolsRow = document.getElementById('tools-row');
    if (toolsRow) toolsRow.remove();

    // حذف محتوای جدول
    tableBody.innerHTML = '';
    tableHead.innerHTML = '';
    loadedCount = 0;
}

document.getElementById('exportToExcel').addEventListener('click', async () => {
    const featuresToExport = filteredGeojson ? filteredGeojson.features : currentFeatures;
    if (!featuresToExport || featuresToExport.length === 0) {
        alert('هیچ داده‌ای برای صادرات وجود ندارد!');
        return;
    }

    // فقط ستون‌های انتخاب‌شده توسط کاربر
    const selectedKeys = Array.from(document.querySelectorAll('.column-checkbox:checked')).map(cb => cb.value);

    const headerRow = selectedKeys.map(key => persianName[key] || key);
    const tableData = [headerRow];

    featuresToExport.forEach(feature => {
        const rowData = selectedKeys.map(key => {
            const val = feature.properties[key];
            return val !== undefined ? val : '';
        });
        tableData.push(rowData);
    });

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('جدول');

    const logoUrl = '/static/images/logo.png';
    try {
        const logoBase64 = await urlToBase64(logoUrl);
        const imageId = workbook.addImage({
            base64: logoBase64,
            extension: 'png',
        });
        worksheet.addImage(imageId, {
            tl: {col: 8, row: 0},
            ext: {width: 100, height: 100}
        });
    } catch (error) {
    }

    const title = selectedFeatureName || 'جدول داده‌ها';
    const titleRow = worksheet.addRow([title]);
    worksheet.mergeCells(`A${titleRow.number}:Z${titleRow.number}`);
    const titleCell = worksheet.getCell(`A${titleRow.number}`);
    titleCell.alignment = {horizontal: 'center', vertical: 'middle'};
    titleCell.font = {name: 'B Nazanin', size: 20, bold: true};

    worksheet.addRow([]);
    worksheet.addRow([]);
    worksheet.addRow([]);

    const headerRowExcel = worksheet.addRow(headerRow);
    headerRowExcel.font = {name: 'B Nazanin', bold: true, size: 13};
    headerRowExcel.alignment = {horizontal: 'center', vertical: 'middle'};
    headerRowExcel.eachCell(cell => {
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: {argb: 'FFCCE5FF'}
        };
        cell.border = {
            top: {style: 'thin'},
            left: {style: 'thin'},
            bottom: {style: 'thin'},
            right: {style: 'thin'}
        };
    });

    tableData.slice(1).forEach(rowData => {
        const row = worksheet.addRow(rowData);
        row.font = {name: 'B Nazanin', size: 12};
        row.eachCell(cell => {
            cell.border = {
                top: {style: 'thin'},
                left: {style: 'thin'},
                bottom: {style: 'thin'},
                right: {style: 'thin'}
            };
        });
    });

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });
    saveAs(blob, 'table.xlsx'.replace('table', selectedFeatureName));
});

async function urlToBase64(url) {
    const response = await fetch(url);
    const blob = await response.blob();
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

document.getElementById('showFilterInMap').addEventListener('click', () => {
    const featuresToShow = filteredGeojson?.features?.length > 0
        ? filteredGeojson.features
        : currentFeatures;
    addGroupLayerWithFeatures(featuresToShow, true, 'فیلتر جدول');
});

function toggleColumns() {
    const checkboxes = document.querySelectorAll('.column-checkbox');
    const headers = tableHead.querySelectorAll('th');
    const rows = tableBody.querySelectorAll('tr');
    const selectedColumnIds = Array.from(checkboxes)
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);

    if (selectedColumnIds.length === 0) {
        headers.forEach(header => header.style.display = '');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => cell.style.display = '');
        });
    } else {
        headers.forEach(header => {
            const columnKey = header.getAttribute('data-key');
            if (selectedColumnIds.includes(columnKey)) {
                header.style.display = '';
            } else {
                header.style.display = 'none';
            }
        });

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                const columnId = cell.dataset.columnId;
                if (selectedColumnIds.includes(columnId)) {
                    cell.style.display = '';
                } else {
                    cell.style.display = 'none';
                }
            });
        });
    }
}

async function exportGeoJSONToVerticalPDF(index, name = '') {
    showLoadingAlert("در حال پردازش اطلاعات");
    let properties;
    for (let i = 0; i < allGeometry.features.length; i++) {
        if (allGeometry.features[i].properties['dbId'] === index) {
            properties = allGeometry.features[i].properties;
            break;
        }
    }
    if (!properties) {
        Swal.close();
        return;
    }
    let imgSrc = properties.sardar;
    let img = '';
    if (imgSrc && imgSrc.startsWith("blob:")) {
        try {
            const base64Image = await convertBlobToBase64(imgSrc);
            imgSrc = base64Image;
        } catch (err) {
            imgSrc = null;
        }
    }
    if (imgSrc) {
        img = `<img src='${imgSrc}' style="height: 300px; display: block; margin: 0 auto;">`;
    }
    const element = document.getElementById('attTable');
    const exportPDF = document.getElementById('exportPDF');
    const nameHeader = `<h2 style="text-align: center; margin-bottom: 20px;">${name}</h2>`;
    exportPDF.innerHTML = nameHeader + img + element.innerHTML;
    const tableList = exportPDF.querySelectorAll('table.table');
    if (tableList.length > 0) {
        tableList[0].className = '';
    }
    const rows = exportPDF.querySelectorAll('tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td, th');
        if (cells.length > 0) {
            cells[0].remove();
        }
    });
    const table = exportPDF.querySelector('table');
    if (table) {
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.fontFamily = 'Tahoma, sans-serif';
        table.style.fontSize = '12px';
    }
    const tdsAndThs = exportPDF.querySelectorAll('td, th');
    tdsAndThs.forEach(cell => {
        cell.style.border = '1px solid #333';
        cell.style.padding = '6px';
        cell.style.textAlign = 'right';
        cell.style.verticalAlign = 'middle';
    });
    exportPDF.style.direction = 'rtl';
    const options = {
        margin: [10, 10, 10, 10],
        filename: `${name || 'export'}.pdf`,
        image: {type: 'jpeg', quality: 0.98},
        html2canvas: {scale: 2},
        jsPDF: {
            unit: 'mm',
            format: 'a4',
            orientation: 'portrait',
        }
    };
    html2pdf().from(exportPDF).set(options).save();
    Swal.close();
}

function convertToDMS(deg) {
    let degree = Math.floor(deg);
    let minutes = Math.floor((deg - degree) * 60);
    let seconds = ((deg - degree - minutes / 60) * 3600).toFixed(2);
    return `${degree}° ${minutes}' ${seconds}"`;
}

proj4.defs([
    ['EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs'],
    ['EPSG:32632', '+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs']  // اضافه کردن پروجکشن UTM
]);

function convertToUTM(lat, lon) {
    proj4.defs([
        ['EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs'],
        ['EPSG:32632', '+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs']
    ]);
    var utmCoordinates = proj4('EPSG:4326', 'EPSG:32632', [lon, lat]);
    return utmCoordinates; // [easting, northing]
}

async function exportGeoJSONToExcelLat(index) {
    showLoadingAlert("در حال پردازش اطلاعات");
    let properties;
    for (let i = 0; i < allGeometry.features.length; i++) {
        if (allGeometry.features[i].properties['dbId'] === index) {
            properties = allGeometry.features[i];
            break;
        }
    }
    if (!properties) {
        alert("ویژگی با این dbId یافت نشد.");
        return;
    }
    const coordinates = properties.geometry.coordinates[0];
    const data = [];

    for (let i = 0; i < coordinates.length; i++) {
        const [lon, lat] = coordinates[i];
        const latDMS = convertToDMS(lat);
        const lonDMS = convertToDMS(lon);
        const utm = convertToUTM(lat, lon);
        data.push({
            lat: lat,
            lon: lon,
            latDMS: latDMS,
            lonDMS: lonDMS,
            utmEast: utm[0],
            utmNorth: utm[1]
        });
    }
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Polygon Data");
    XLSX.writeFile(wb, "GeoJSON_Polygon_Data.xlsx");
    Swal.close();
}

function enablePolygonEditFromClick() {
    const layer = window.selectedLayer;
    if (!layer) {
        return;
    }
    if (typeof layer.enableEdit !== 'function') {
        return;
    }
    if (!layer.editEnabled) {
        var dbId = layer.toGeoJSON().properties.dbId;
        layer.editEnabled = true;
        layer.enableEdit();
        layer.on('editable:vertex:dragend', function () {
            const updatedGeoJSON = layer.toGeoJSON();
            updatePolygonGeometry(dbId, updatedGeoJSON.geometry);
        });
        layer.on('editable:edit', function () {
        });
    } else {
        layer.editEnabled = false;
        layer.disableEdit();
    }
}

function updatePolygonGeometry(dbId, geometry) {
    showLoadingAlert("در حال به‌روزرسانی مختصات...");

    const formData = new FormData();
    formData.append('dbId', dbId);
    formData.append('geom', JSON.stringify(geometry));

    setTimeout(function () {
        $.ajax({
            type: "POST",
            headers: {
                'X-CSRFToken': csrftoken,
            },
            url: "/update-geometry",
            data: formData,
            contentType: false,
            processData: false,
            success: function (data) {
                Swal.close();
                if (data.status === 'success') {
                    showTimerGreenAlert("مختصات با موفقیت به‌روزرسانی شد", 2000);
                } else {
                    showTimerRedAlert('خطا در به‌روزرسانی مختصات', 2000);
                }
            },
            error: function () {
                showTimerRedAlert("ارسال اطلاعات با خطا همراه بود", 2000);
            }
        });
    }, 500);
}

function addGroupLayerWithFeatures(geoJsonFeatures, showLayer, layerName, isBookmark = false) {
    const groupLayer = L.featureGroup();
    const newGroupLayer = L.featureGroup();
    const styleLayer1 = {
        color: '#FF5733',
        weight: 2,
        opacity: 0.7,
        fillColor: '#FF5733',
        fillOpacity: 0.2
    };
    const styleLayer2 = {
        color: '#33FF57',
        weight: 3,
        opacity: 0.8,
        fillColor: '#33FF57',
        fillOpacity: 0.3
    };
    geoJsonFeatures.forEach((feature) => {
        const category = feature.properties.tmelk;
        const style = category === 'commercial' ? styleLayer1 : styleLayer2;
        const layer = L.geoJSON(feature, {style});
        const bounds = layer.getBounds();
        const center = bounds.getCenter();
        const marker = L.marker(center, {icon: icons[category] || icons['default']});
        const area = feature.properties.arse;
        const newArea = Number.parseInt(area).toLocaleString('en-US');

        layer.on('add', function () {
            const currentZoom = map.getZoom();
            if (currentZoom >= 15) {
                newGroupLayer.addLayer(layer);
            }
        });
        marker.on('click', function () {
            map.flyToBounds(bounds, {padding: [200, 200], duration: 3}).once('zoomend', function () {
                const popupLatLng = L.latLng(center.lat + 0.0001, center.lng);
                const toolContent = `
                    <div class="tool-container text-right" dir="rtl">
                        <h6>${feature.properties.onvan || 'بدون نام'}</h6>
                        <div class="tool-list justify-content-around text-center d-flex">
                            <div onclick="openLayerComment(${feature.properties.dbId})" class="pointerCursor p-1 border border-secondary rounded m-1">
                                <img src="${downloadSVG}" width="40px" alt=""><br>
                                <small>یادداشت</small>
                            </div>
                            <div class="pointerCursor p-1 border border-secondary rounded m-1" onclick="printLayerDetails(${feature.properties.dbId}, '${center.lat}', '${center.lng}')">
                                <img src="${detailSVG}" width="40px" alt=""><br>
                                <small>جزئیات</small>
                            </div>
                            <div onclick="openLayerDocuments(${feature.properties.dbId})" class="pointerCursor p-1 border border-secondary rounded m-1">
                                <img src="${documentSVG}" width="40px" alt=""><br>
                                <small>اسناد</small>
                            </div>
                        </div>
                        <div class="text-center mt-2"><small>مساحت: ${newArea} متر مربع</small></div>
                    </div>`;

                L.popup()
                    .setLatLng(popupLatLng)
                    .setContent(toolContent)
                    .openOn(map);
            });
        });

        newGroupLayer.addLayer(marker);
        newGroupLayer.addLayer(layer);
        map.on('zoomend', function () {
            const currentZoom = map.getZoom();
            if (currentZoom >= 17) {
                const textIcon = L.divIcon({
                    className: 'custom-text-icon',
                    html: `<div style="text-align: center; background-color: #373b3e; color: white; padding: 2px; border-radius: 10px; font-size: 11px; white-space: nowrap; display: inline-block; margin-top: 20px;">
                        ${feature.properties.onvan || 'بدون عنوان'}
                    </div>`
                });
                const textMarker = L.marker(center, {icon: textIcon});
                newGroupLayer.addLayer(textMarker);
            } else {
                newGroupLayer.eachLayer(layer => {
                    if (layer instanceof L.Marker && layer.options.icon.options.className === 'custom-text-icon') {
                        newGroupLayer.removeLayer(layer);
                    }
                });
            }
        });
    });
    if (showLayer) {
        groupLayer.addTo(map);
        newGroupLayer.addTo(map);
    }
    var newAllLayerDiv = document.createElement('div')
    newAllLayerDiv.className = 'd-flex justify-content-between p-3'
    var newLayerCanvasDiv = document.createElement('div')
    newLayerCanvasDiv.className = 'd-flex justify-content-end'
    var newLayerCheckInput = document.createElement('input')
    newLayerCheckInput.type = 'checkbox'
    newLayerCheckInput.checked = showLayer
    newLayerCheckInput.className = 'form-check-input rounded'
    newLayerCheckInput.style.backgroundColor = "black";
    newLayerCheckInput.addEventListener('click', function () {
        if (newLayerCheckInput.checked) {
            groupLayer.addTo(map)
            newGroupLayer.addTo(map)
        } else {
            map.removeLayer(groupLayer)
            map.removeLayer(newGroupLayer)
        }
    });
    var newLayerCheckName = document.createElement('small')
    newLayerCheckName.style.marginRight = '10px'
    newLayerCheckName.innerText = layerName

    newLayerCanvasDiv.appendChild(newLayerCheckName)
    newLayerCanvasDiv.appendChild(newLayerCheckInput)

    var newLayerDropdown = document.createElement('div');
    newLayerDropdown.className = 'dropdown';

    var dropdownButton = document.createElement('span');
    dropdownButton.className = 'dropdown-toggle';
    dropdownButton.type = 'button';
    dropdownButton.innerText = 'ابزار ها'
    dropdownButton.setAttribute('data-bs-toggle', 'dropdown');

    var dropdownMenu = document.createElement('ul');
    dropdownMenu.className = 'dropdown-menu';

    var option1 = document.createElement('li');
    var option1Link = document.createElement('a');
    option1Link.className = 'dropdown-item text-end';
    option1Link.innerText = 'بزرگنمایی';
    option1.onclick = function () {
        const bounds = newGroupLayer.getBounds();
        const zoomLevel = map.getBoundsZoom(bounds);
        const center = bounds.getCenter();
        map.flyTo(center, zoomLevel);
    }
    option1.appendChild(option1Link);

    var option2 = document.createElement('li');
    var option2Link = document.createElement('a');
    option2Link.className = 'dropdown-item text-end';
    option2Link.innerText = 'دانلود اکسل';
    option2Link.onclick = function () {
        downloadGeojsonToExcel(geoJsonFeatures, layerName)
    }
    option2.appendChild(option2Link);

    var option21 = document.createElement('li');
    var option21Link = document.createElement('a');
    option21Link.className = 'dropdown-item text-end';
    option21Link.innerText = 'geojson';
    option21Link.onclick = function () {
        downloadGeojsonFile(geoJsonFeatures, layerName)
    }
    option21.appendChild(option21Link);

    var option3 = document.createElement('li');
    var option3Link = document.createElement('a');
    option3Link.className = 'dropdown-item text-end';
    option3Link.innerText = 'دانلود kml';
    option3Link.onclick = function () {
        downloadToKML(geoJsonFeatures, newLayerCheckName.innerText)
    }
    option3.appendChild(option3Link);

    var option4 = document.createElement('li');
    var option4Link = document.createElement('a');
    option4Link.className = 'dropdown-item text-end';
    option4Link.innerText = 'جدول توصیفی';
    option4Link.onclick = function () {
        clearTableState();
        loadedCount = 0;
        selectedFeatureName = layerName
        showLoadingAlert('در حال بارگذاری اطلاعات')
        const searchInput = document.getElementById('searchInput');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        let searchResults = [];
        let currentIndex = -1;
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();
            const rows = tableBody.getElementsByTagName('tr');
            searchResults = [];
            currentIndex = -1;
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let rowMatches = false;
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        rowMatches = true;
                        break;
                    }
                }
                rows[i].style.display = rowMatches ? '' : 'none';
                if (rowMatches) {
                    searchResults.push(rows[i]);
                }
            }
        });

        function highlightRow(index) {
            searchResults.forEach(row => row.classList.remove('highlight'));
            if (index >= 0 && index < searchResults.length) {
                searchResults[index].classList.add('highlight');
                searchResults[index].scrollIntoView({behavior: 'smooth', block: 'center'});
            }
        }

        prevBtn.addEventListener('click', () => {
            if (searchResults.length > 0 && currentIndex > 0) {
                currentIndex--;
                highlightRow(currentIndex);
            }
        });

        nextBtn.addEventListener('click', () => {
            if (searchResults.length > 0 && currentIndex < searchResults.length - 1) {
                currentIndex++;
                highlightRow(currentIndex);
            }
        });

        initializeDropdown(geoJsonFeatures);

        initializeTable(geoJsonFeatures);
    }
    option4.appendChild(option4Link);

    var option5 = document.createElement('li');
    var option5Link = document.createElement('a');
    option5Link.className = 'dropdown-item text-end';
    option5Link.setAttribute('data-bs-toggle', 'modal')
    option5Link.setAttribute('data-bs-target', '#selectByAttributeModal')
    option5Link.innerText = 'فیلتر گذاری';
    option5.onclick = function () {
        allFeatures = geoJsonFeatures;
        populateAttributeFields(allFeatures);
    }
    option5.appendChild(option5Link);
    var option10 = document.createElement('li');
    var option10Link = document.createElement('a');
    option10Link.className = 'dropdown-item text-end';
    option10Link.innerText = 'تغییر نام';
    option10Link.onclick = function () {
        let offcanvasEl = document.getElementById('layersOffCanvas');
        let bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
        if (!bsOffcanvas) {
            bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
        }
        bsOffcanvas.hide();

        const modal = new bootstrap.Modal(document.getElementById('renameLayer'));
        modal.show();
        var modalBody = document.getElementById('renameModalBody')
        modalBody.innerHTML = ''

        var modalFooter = document.getElementById('renameModalFooter')
        modalFooter.innerHTML = ''
        var nameInput = document.createElement('input')
        nameInput.placeholder = 'نام جدید را وارد کنید'
        nameInput.className = 'form-control'
        modalBody.appendChild(nameInput)

        var button = document.createElement('button')
        button.className = 'btn btn-success'
        button.innerText = "ویرایش نام"
        button.onclick = function () {
            if (nameInput.value === '') {
                showTimerRedAlert("یک نام را انتخاب کنید")
            } else {
                showLoadingAlert('در حال تغییر نام', 2000)
                const formData = new FormData();
                formData.append('mainId', geoJsonFeatures[0].properties.mainGeoData);
                formData.append('name', nameInput.value);
                setTimeout(function () {
                    $.ajax({
                        type: "post",
                        headers: {
                            'X-CSRFToken': csrftoken,
                        },
                        url: "/rename-layer",
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function (data) {
                            if (data['check']) {
                                newLayerCheckName.innerText = nameInput.value
                                showLoadingAlert('تغییر نام انجام شد', 2000)
                            }
                        },
                    });
                }, 500);
            }

        }
        modalFooter.appendChild(button)
    }
    option10.appendChild(option10Link);

    var option6 = document.createElement('li');
    option6.className = 'position-relative';
    var option6Link = document.createElement('a');
    option6Link.className = 'dropdown-item text-end';
    option6Link.innerText = 'نمودار گزارش';
    option6Link.style.cursor = 'pointer';
    option6.appendChild(option6Link);

    var option9 = document.createElement('li');
    option9.className = 'position-relative';
    var option9Link = document.createElement('a');
    option9Link.className = 'dropdown-item text-end text-success';
    option9Link.innerText = 'ذخیره';
    option9Link.style.cursor = 'pointer';
    option9Link.onclick = function () {
        showLoadingAlert('در حال ذخیره اطلاعات')
        const geojsonObject = {
            type: 'FeatureCollection',
            features: geoJsonFeatures
        };
        const geojsonString = JSON.stringify(geojsonObject);
        const geojsonBlob = new Blob([geojsonString], {type: 'application/json'});
        const formData = new FormData();
        formData.append('geojson', geojsonBlob, 'geojson.geojson');
        formData.append('name', layerName)
        setTimeout(function () {
            $.ajax({
                type: "post",
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                url: "/save-bookmark",
                data: formData,
                contentType: false,
                processData: false,
                success: function (data) {
                    if (data.exist) {
                        showTimerRedAlert("لایه ای با این نام قبلا ذخیره شده است", 2000)
                    } else if (data.check) {
                        showTimerGreenAlert("ذخیره لایه با موفقیت انجام شد", 2000)
                    } else {
                        showTimerRedAlert('ثبت اطلاعات با خطا همراه بود', 2000);
                    }
                },
            });
        }, 500);
    }
    option9.appendChild(option9Link);

    var subMenu = document.createElement('div');
    subMenu.className = 'position-absolute border rounded p-2 shadow bg-dark';
    subMenu.style.top = option6Link.offsetHeight + 'px';
    subMenu.style.left = '0';
    subMenu.style.overflowY = 'scroll';
    subMenu.style.height = '250px';

    subMenu.style.right = 'auto';
    subMenu.style.minWidth = '200px';
    subMenu.style.display = 'none';
    subMenu.style.zIndex = '1000';

    var searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'جستجو...';
    searchInput.className = 'form-control mb-2';
    subMenu.appendChild(searchInput);

    var itemsList = document.createElement('ul');
    itemsList.className = 'list-unstyled mb-0';
    Object.entries(persianName).forEach(function ([key, value]) {
        var item = document.createElement('li');
        var link = document.createElement('a');
        link.onclick = function () {
            showLoadingAlert('در حال آنالیز اطلاعات')

            const geojsonObject = {
                type: 'FeatureCollection',
                features: geoJsonFeatures
            };
            const geojsonString = JSON.stringify(geojsonObject);
            const geojsonBlob = new Blob([geojsonString], {type: 'application/json'});
            const formData = new FormData();
            formData.append('geojson', geojsonBlob, 'geojson.geojson');
            setTimeout(function () {
                $.ajax({
                    type: "post",
                    headers: {
                        'X-CSRFToken': csrftoken,
                    },
                    url: "/create-chart",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        Swal.close()
                        if (data.check) {
                            window.open('/get-temporary-chart/cartId/key'
                                .replace('cartId', data.chartId)
                                .replace('key', key), '_blank');

                        } else {
                            showTimerRedAlert('ثبت اطلاعات با خطا همراه بود', 2000);
                        }
                    },
                });
            }, 500);
        }
        link.className = 'dropdown-item text-end';
        link.innerText = value;
        link.setAttribute('data-key', key);
        item.appendChild(link);
        itemsList.appendChild(item);
    });
    subMenu.appendChild(itemsList);
    option6.appendChild(subMenu);

    option6.addEventListener('mouseenter', function () {
        subMenu.style.display = 'block';
    });
    option6.addEventListener('mouseleave', function () {
        subMenu.style.display = 'none';
    });

    searchInput.addEventListener('input', function () {
        var value = this.value.toLowerCase();
        Array.from(itemsList.children).forEach(function (li) {
            if (li.innerText.toLowerCase().includes(value)) {
                li.style.display = '';
            } else {
                li.style.display = 'none';
            }
        });
    });

    var option8 = document.createElement('li');
    var option8Link = document.createElement('a');
    option8Link.className = 'dropdown-item text-end';
    option8Link.innerText = 'مساحت کلی';
    option8Link.onclick = function () {
        var allArea = 0;
        var allArea1 = 0;
        for (var f = 0; f < geoJsonFeatures.length; f++) {
            allArea += geoJsonFeatures[f]['properties']['arse'];
            allArea1 += geoJsonFeatures[f]['properties']['aeian'];
        }

        let formattedAllArea = Math.floor(allArea);
        let formattedAllAreaInHectar = Math.floor(allArea / 10000);
        let formattedAllArea1 = allArea1.toLocaleString('fa-IR');

        Swal.fire({
            html: `<h5>مجموع کل مساحت: ${formattedAllArea.toLocaleString()} متر مربع</h5>
               <small style="color: gray;">(${formattedAllAreaInHectar} هکتار)</small>
               <h5 class="mt-2" style="color: gray;">مجموع اعیان کل: ${formattedAllArea1} متر مربع</h5>`,
            icon: "success",
            draggable: true,
            confirmButtonText: "بستن"
        });
    };
    option8.appendChild(option8Link);

    var option11 = document.createElement('li');
    var option11Link = document.createElement('a');
    option11Link.className = 'dropdown-item text-end';
    option11Link.innerText = 'دسته بندی';
    option11Link.onclick = function () {
        selectedGeometryForClassify = geoJsonFeatures;
        const offcanvasElement = document.getElementById('layersOffCanvas');
        const offcanvas = bootstrap.Offcanvas.getInstance(offcanvasElement);
        if (offcanvas) {
            offcanvas.hide();
        }

        const modal = new bootstrap.Modal(document.getElementById('ClassifyModal'));
        modal.show();

    };
    option11.appendChild(option11Link);

    var option7 = document.createElement('li');
    var option7Link = document.createElement('a');
    option7Link.className = 'dropdown-item text-end text-danger';
    option7Link.innerText = 'حذف';
    option7Link.onclick = function () {
        layerOffCanvas.removeChild(newAllLayerDiv)
        map.removeLayer(groupLayer)
        map.removeLayer(newGroupLayer)
        if (isBookmark) {
            showLoadingAlert('در حال حذف تغییرات')
            const formData = new FormData();
            formData.append('name', layerName,);
            setTimeout(function () {
                $.ajax({
                    type: "post",
                    headers: {
                        'X-CSRFToken': csrftoken,
                    },
                    url: "/delete-bookmark",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        if (!data.exist) {
                            showTimerGreenAlert("لایه ای با این نام یافت نشد")
                        } else if (data.check) {
                            showTimerGreenAlert("لایه حذف شد")
                        } else {
                            showTimerRedAlert('ثبت اطلاعات با خطا همراه بود', 2000);
                        }
                    },
                });
            }, 500);

        }
    }
    option7.appendChild(option7Link);

    dropdownMenu.appendChild(option1);
    dropdownMenu.appendChild(option2);
    dropdownMenu.appendChild(option21);
    dropdownMenu.appendChild(option3);
    dropdownMenu.appendChild(option4);
    dropdownMenu.appendChild(option5);
    dropdownMenu.appendChild(option10);
    dropdownMenu.appendChild(option11);
    dropdownMenu.appendChild(option8);
    dropdownMenu.appendChild(option9);
    dropdownMenu.appendChild(option7);
    dropdownMenu.appendChild(option6);

    newLayerDropdown.appendChild(dropdownButton);
    newLayerDropdown.appendChild(dropdownMenu);
    newAllLayerDiv.appendChild(newLayerDropdown)
    newAllLayerDiv.appendChild(newLayerCanvasDiv)

    layerOffCanvas.appendChild(newAllLayerDiv)
    var hr = document.createElement('hr')
    hr.className = 'p-0 m-0'
    layerOffCanvas.append(hr)
}

document.getElementById('selectByAttributeModal').addEventListener('shown.bs.modal', function () {
    var myOffcanvas = document.getElementById('layersOffCanvas');
    var bsOffcanvas = bootstrap.Offcanvas.getInstance(myOffcanvas);
    bsOffcanvas.hide();
});

function downloadGeojsonFile(geojson, fileName) {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geojson));
    const anchor = document.createElement('a');
    anchor.setAttribute("href", dataStr);
    anchor.setAttribute("download", fileName + ".geojson");
    document.body.appendChild(anchor);
    anchor.click();
    anchor.remove();
}

